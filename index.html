<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ALDISAN-KSK – REPORTE DE EMBARQUE (Tarimas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Librerías -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{--c1:#00e5ff;--bg:#0c0f1f;--muted:#93a4b8;--paper-w:21.59cm;--paper-h:27.94cm;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#0c0f1f;color:#e6eef7}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header h1{text-align:center;color:var(--c1);font-weight:800}
    header p{text-align:center;color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:1.1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;color:#fff}
    #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px solid rgba(255,255,255,.08);overflow:hidden;position:relative}
    .scan-flash{position:absolute;inset:0;background:rgba(0,255,170,.15);opacity:0;transition:.2s}
    .scan-flash.show{opacity:1}
    .idle-overlay{position:absolute;inset:0;display:none;place-items:center;text-align:center;background:rgba(2,8,23,.85);padding:24px}
    .idle-overlay.active{display:grid}
    .idle-overlay button{margin-top:10px;padding:10px 16px;border-radius:10px;background:#0f1b2e;color:#fff}
    label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:#e6eef7}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .primary{background:linear-gradient(90deg,#00e5ff,#36d1dc);color:#00131a;font-weight:700}
    .success{background:linear-gradient(90deg,#00d26a,#23e0a5);color:#001a0d;font-weight:700}
    .danger{background:linear-gradient(90deg,#ff7373,#ff4d4d);color:#2a0000;font-weight:700}
    .ghost{background:#0f2438;color:#fff;border:1px solid rgba(255,255,255,.12)}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#0d1526}
    th,td{border:1px solid rgba(255,255,255,.08);padding:8px 10px;text-align:left}
    th{color:#a9c8ff;background:rgba(255,255,255,.04)}
    .qr-block{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #qrCarga{width:140px;height:140px;background:#fff;border-radius:8px;padding:6px}
    footer{margin:18px 0 8px;text-align:center;color:#9fb0c5;font-size:12px}

    /* IMPRESIÓN */
    @page{size:Letter;margin:12mm}
    #printable{background:#fff;color:#000;width:var(--paper-w);min-height:var(--paper-h);margin:0 auto;padding:1.2cm;font-size:12pt}
    #printable h1{text-align:center;color:#00a8c7}
    #printable .meta{display:grid;grid-template-columns:1.5fr .9fr 3.2cm;gap:.5cm;margin:.4cm 0 .3cm}
    #printable .box{border:1px solid #000;padding:.35cm;border-radius:6px}
    #printable #qrBox{border:1px solid #000;padding:.2cm;display:flex;align-items:center;justify-content:center}
    #printable #qrInner{width:3.2cm;height:3.2cm;display:flex;align-items:center;justify-content:center}
    #printable table{width:100%;border-collapse:collapse;margin-top:.5cm;font-size:11pt;background:#fff}
    #printable th,#printable td{border:1px solid #000;padding:.2cm;text-align:left}
    #printable thead th{background:#f2f2f2;color:#000}
    #printable .firmas{display:grid;grid-template-columns:1fr 1fr;gap:1cm;margin-top:1cm}
    #printable .firma{height:2.5cm;border-top:1px solid #000;text-align:center;padding-top:.2cm}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
    <p>Escanea los QR de las tarimas. Guarda, imprime o exporta a Excel.</p>
  </header>

  <div class="grid">
    <section class="card">
      <h2>1) Escáner QR</h2>
      <div id="reader"><div class="scan-flash" id="scanFlash"></div><div class="idle-overlay" id="idleOverlay"><button id="btnResume">Reactivar cámara</button></div></div>
      <div class="actions"><button id="btnStart" class="primary">Iniciar cámara</button><button id="btnStop" class="ghost">Detener cámara</button><select id="cameraSelect"></select></div>
      <div>Total escaneos: <b id="totalCount">0</b> · Cámara: <b id="camStatus">Detenida</b></div>
    </section>

    <section class="card">
      <h2>2) Datos de embarque</h2>
      <div class="row"><div><label>Operador</label><input id="inpOperador"/></div><div><label>Placas</label><input id="inpPlacas"/></div></div>
      <div class="row" style="margin-top:10px"><div><label>Unidad</label><select id="selUnidad"><option>Camioneta</option><option>Tráiler</option><option>Torton</option><option>Otro</option></select></div><div><label>Factura/Pedimento</label><input id="inpFactura"/></div></div>
      <div style="margin-top:12px" class="qr-block"><div id="qrCarga"></div></div>
      <div class="actions"><button id="btnExportXLSX" class="success">Exportar Excel</button><button id="btnExportCSV" class="ghost">Exportar CSV</button><button id="btnPrint" class="primary">Imprimir / PDF</button><button id="btnClear" class="danger">Borrar todo</button></div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>3) Tarimas escaneadas</h2>
    <table><thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead><tbody id="tbody"></tbody></table>
  </section>

  <section id="printable" style="display:none">
    <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
    <div class="meta">
      <div class="box"><b>Operador:</b> <span id="pOperador"></span><br><b>Placas:</b> <span id="pPlacas"></span><br><b>Unidad:</b> <span id="pUnidad"></span><br><b>Factura:</b> <span id="pFactura"></span><br><b>Fecha:</b> <span id="pFecha"></span></div>
      <div class="box"><b>Total tarimas:</b> <span id="pTotal"></span><br><b>Código:</b> <span id="pCodigo"></span></div>
      <div id="qrBox"><div id="qrInner"></div></div>
    </div>
    <table><thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead><tbody id="pTbody"></tbody></table>
    <div class="firmas"><div class="firma" id="pFirmaOperador">OPERADOR</div><div class="firma">VÍCTOR GONZÁLES</div></div>
  </section>
  <footer>© ALDISAN-KSK · Herramienta local</footer>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const state={scans:[],form:{operador:"",placas:"",unidad:"Camioneta",factura:""}};

/* QR */
const getPayload=()=>({meta:{v:1},...state.form,total:state.scans.length,items:state.scans});
function drawQR(el,size,text){el.innerHTML="";new QRCode(el,{text,width:size,height:size});}
function refreshQR(){const p=JSON.stringify(getPayload());drawQR($("#qrCarga"),140,p);drawQR($("#qrInner"),120,p);}
function renderTable(){const tb=$("#tbody");tb.innerHTML="";state.scans.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`;tb.appendChild(tr);});}
function preparePrint(){ $("#pOperador").textContent=state.form.operador;$("#pPlacas").textContent=state.form.placas;$("#pUnidad").textContent=state.form.unidad;$("#pFactura").textContent=state.form.factura;$("#pFecha").textContent=fmt(new Date());$("#pTotal").textContent=state.scans.length;$("#pCodigo").textContent=(state.form.operador||"-").slice(0,3).toUpperCase()+"-"+(state.form.placas||"---");$("#pFirmaOperador").textContent=(state.form.operador||"OPERADOR").toUpperCase();const pt=$("#pTbody");pt.innerHTML="";state.scans.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`;pt.appendChild(tr);});refreshQR();}

/* Export */
function makeAOA(){const a=[["ALDISAN-KSK REPORTE DE EMBARQUE"],["Operador",state.form.operador],["Placas",state.form.placas],["Unidad",state.form.unidad],["Factura",state.form.factura],["Fecha",fmt(new Date())],[],["#","Contenido QR","Fecha/Hora"]];state.scans.forEach((s,i)=>a.push([i+1,s.text,fmt(new Date(s.ts))]));return a;}
function exportCSV(){const csv=makeAOA().map(r=>r.join(",")).join("\n");const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="reporte.csv";a.click();}
function exportXLSX(){try{const ws=XLSX.utils.aoa_to_sheet(makeAOA());ws['!cols']=[{wch:5},{wch:80},{wch:20}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Embarque");XLSX.writeFile(wb,"reporte.xlsx");}catch(e){exportCSV();}}

/* Escáner */
let html5Scanner=null;
async function startCamera(){if(html5Scanner){try{await html5Scanner.stop();}catch{}html5Scanner=null;}const camId=$("#cameraSelect").value||{facingMode:{exact:"environment"}};html5Scanner=new Html5Qrcode("reader");try{await html5Scanner.start(camId,{fps:10,qrbox:{width:260,height:260}},txt=>{state.scans.push({id:uid(),text:txt,ts:new Date().toISOString()});renderTable();refreshQR();});$("#camStatus").textContent="Activa";}catch(e){alert("No se pudo iniciar la cámara");}}
async function stopCamera(){if(html5Scanner){try{await html5Scanner.stop();}catch{}try{await html5Scanner.clear();}catch{}html5Scanner=null;}$("#camStatus").textContent="Detenida";}

/* Print via iframe */
function snapshotQRInto(node){const c=document.querySelector('#qrInner canvas');if(!c)return;const img=new Image();img.src=c.toDataURL('image/png');const d=node.querySelector('#qrInner');d.innerHTML="";d.appendChild(img);}
function printViaIframe(){preparePrint();const clone=$("#printable").cloneNode(true);snapshotQRInto(clone);const iframe=document.createElement("iframe");iframe.style.position="fixed";iframe.style.width="0";iframe.style.height="0";iframe.style.border="0";document.body.appendChild(iframe);const doc=iframe.contentDocument||iframe.contentWindow.document;doc.open();doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Imprimir</title><style>${document.querySelector("style").innerHTML}</style></head><body>${clone.outerHTML}</body></html>`);doc.close();iframe.onload=()=>{iframe.contentWindow.focus();iframe.contentWindow.print();setTimeout(()=>document.body.removeChild(iframe),1500);};}

/* Eventos */
$("#btnStart").onclick=startCamera;$("#btnStop").onclick=stopCamera;$("#btnExportXLSX").onclick=exportXLSX;$("#btnExportCSV").onclick=exportCSV;$("#btnPrint").onclick=printViaIframe;$("#btnClear").onclick=()=>{state.scans=[];state.form={operador:"",placas:"",unidad:"Camioneta",factura:""};renderTable();refreshQR();};
$("#inpOperador").oninput=e=>{state.form.operador=e.target.value;refreshQR();};$("#inpPlacas").oninput=e=>{state.form.placas=e.target.value;refreshQR();};$("#selUnidad").onchange=e=>{state.form.unidad=e.target.value;refreshQR();};$("#inpFactura").oninput=e=>{state.form.factura=e.target.value;refreshQR();};
refreshQR();
</script>
</body>
</html>