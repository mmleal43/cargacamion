<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ALDISAN-KSK – REPORTE DE EMBARQUE (Tarimas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Librerías -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --c1:#00e5ff; --bg:#0c0f1f; --panel:#151a2b; --muted:#93a4b8;
      --paper-w:21.59cm; --paper-h:27.94cm;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(1000px 600px at 50% -200px,#16304a 10%, var(--bg) 60%, #090c17 100%);
      color:#e6eef7;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header h1{text-align:center;color:var(--c1);font-weight:800;text-shadow:0 0 8px rgba(0,229,255,.35)}
    header p{text-align:center;color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:1.1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;color:#fff}
    /* Escáner */
    #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px solid rgba(255,255,255,.08);overflow:hidden;position:relative}
    .scan-flash{position:absolute;inset:0;background:rgba(0,255,170,.15);box-shadow:inset 0 0 0 2px rgba(0,255,170,.4);opacity:0;transform:scale(1.02);transition:.2s}
    .scan-flash.show{opacity:1;transform:scale(1)}
    .idle-overlay{position:absolute;inset:0;display:none;place-items:center;text-align:center;background:rgba(2,8,23,.85);padding:24px}
    .idle-overlay.active{display:grid}
    .idle-overlay button{margin-top:10px;padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1b2e;color:#fff}
    label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:#e6eef7}
    input:focus,select:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,229,255,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .primary{background:linear-gradient(90deg,#00e5ff,#36d1dc);color:#00131a;font-weight:700}
    .success{background:linear-gradient(90deg,#00d26a,#23e0a5);color:#001a0d;font-weight:700}
    .danger{background:linear-gradient(90deg,#ff7373,#ff4d4d);color:#2a0000;font-weight:700}
    .ghost{background:#0f2438;color:#fff;border:1px solid rgba(255,255,255,.12)}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#0d1526}
    th,td{border:1px solid rgba(255,255,255,.08);padding:8px 10px;text-align:left}
    th{color:#a9c8ff;background:rgba(255,255,255,.04)}
    .qr-block{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #qrCarga{width:140px;height:140px;background:#fff;border-radius:8px;padding:6px}
    footer{margin:18px 0 8px;text-align:center;color:#9fb0c5;font-size:12px}

    /* IMPRESIÓN */
    @media print{
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .wrap{max-width:none;padding:0}
      .grid, header p, .actions, #reader, .card:not(.print-only){display:none!important}
      #printable{display:block!important}
    }
    @page{size:Letter;margin:12mm}
    #printable{display:none;background:#fff;color:#000;width:var(--paper-w);min-height:var(--paper-h);margin:0 auto;padding:1.2cm;font-size:12pt}
    #printable h1{text-align:center;color:#00a8c7}
    #printable .meta{display:grid;grid-template-columns:1.5fr .9fr 3.2cm;gap:.5cm;margin:.4cm 0 .3cm}
    #printable .box{border:1px solid #000;padding:.35cm;border-radius:6px}
    #printable #qrBox{border:1px solid #000;border-radius:6px;padding:.2cm;display:flex;align-items:center;justify-content:center}
    #printable #qrInner{width:3.2cm;height:3.2cm;display:flex;align-items:center;justify-content:center;overflow:hidden}
    #printable #qrInner canvas{max-width:100%;max-height:100%;display:block;margin:auto}
    #printable table{width:100%;border-collapse:collapse;margin-top:.5cm;font-size:11pt}
    #printable th,#printable td{border:1px solid #000;padding:.2cm;text-align:left}
    #printable .firmas{display:grid;grid-template-columns:1fr 1fr;gap:1cm;margin-top:1cm}
    #printable .firma{height:2.5cm;border-top:1px solid #000;text-align:center;padding-top:.2cm}
    /* Tabla clara en impresión */
    #printable table{background:#fff!important}
    #printable thead th{background:#f2f2f2!important;color:#000!important;border-color:#000!important}
    #printable tbody td{background:#fff!important;color:#000!important;border-color:#000!important}
    #printable tbody tr{background:#fff!important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <p>Escanea los QR de las tarimas. Guarda, imprime o exporta a Excel. La cámara se pausa sola tras 20 s sin uso.</p>
    </header>

    <div class="grid">
      <!-- 1) Escáner QR -->
      <section class="card">
        <h2>1) Escáner QR</h2>
        <div id="reader">
          <div class="scan-flash" id="scanFlash"></div>
          <div class="idle-overlay" id="idleOverlay">
            <div>
              <div style="font-weight:700; font-size:18px">Cámara pausada por inactividad</div>
              <div style="opacity:.8">Toca “Reactivar cámara” para continuar</div>
              <button id="btnResume" class="ghost">Reactivar cámara</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="btnStart" class="primary">Iniciar cámara</button>
          <button id="btnStop"  class="ghost">Detener cámara</button>
          <select id="cameraSelect" title="Cámara" class="ghost"></select>
        </div>
        <div class="stats" style="margin-top:8px;color:#cfe6ff">
          Total escaneos: <b id="totalCount">0</b> · Cámara: <b id="camStatus">Detenida</b>
        </div>
        <div id="scanError" style="margin-top:6px;color:#ff9b9b;display:none"></div>
      </section>

      <!-- 2) Datos + QR -->
      <section class="card">
        <h2>2) Datos de embarque</h2>
        <div class="row">
          <div><label>Operador</label><input id="inpOperador" placeholder="Nombre del operador" /></div>
          <div><label>Placas</label><input id="inpPlacas" placeholder="ABC-123-X" /></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Tipo de unidad</label>
            <select id="selUnidad">
              <option value="Camioneta">Camioneta</option>
              <option value="Tráiler">Tráiler</option>
              <option value="Torton">Torton</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div><label>Factura/Pedimento</label><input id="inpFactura" placeholder="Factura o Pedimento" /></div>
        </div>
        <div style="margin-top:12px" class="qr-block">
          <div>
            <div style="font-size:12px; color:var(--muted); margin-bottom:6px">QR del embarque (se imprime)</div>
            <div id="qrCarga"></div>
          </div>
          <div class="muted" style="max-width:420px">Este QR codifica operador, placas, unidad, factura/pedimento y todas las tarimas. Se incrusta en la impresión automáticamente.</div>
        </div>
        <div class="actions">
          <button class="success" id="btnExportXLSX">Exportar Excel</button>
          <button class="ghost"   id="btnExportCSV">Exportar CSV</button>
          <button class="primary" id="btnPrint">Imprimir / Guardar PDF</button>
          <button class="danger"  id="btnClear">Borrar todo</button>
        </div>
      </section>
    </div>

    <!-- 3) Tabla -->
    <section class="card" style="margin-top:16px">
      <h2>3) Tarimas escaneadas</h2>
      <table>
        <thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th><th>Acciones</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Vista de impresión -->
    <section id="printable" class="print-only">
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <div class="meta">
        <div class="box">
          <b>Operador:</b> <span id="pOperador"></span><br>
          <b>Placas:</b> <span id="pPlacas"></span><br>
          <b>Tipo de unidad:</b> <span id="pUnidad"></span><br>
          <b>Factura/Pedimento:</b> <span id="pFactura"></span><br>
          <b>Fecha reporte:</b> <span id="pFecha"></span>
        </div>
        <div class="box">
          <b>Total tarimas escaneadas:</b> <span id="pTotal"></span><br>
          <b>Código de embarque:</b> <span id="pCodigo"></span>
        </div>
        <div id="qrBox"><div id="qrInner"></div></div>
      </div>
      <table>
        <thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead>
        <tbody id="pTbody"></tbody>
      </table>
      <div class="firmas">
        <div class="firma" id="pFirmaOperador">OPERADOR</div>
        <div class="firma">VÍCTOR GONZÁLES</div>
      </div>
    </section>

    <footer>© ALDISAN-KSK · Herramienta local de reporte de tarimas</footer>
  </div>

<script>
/* ===== Helpers ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const pad=n=>String(n).padStart(2,'0');
const fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

/* ===== Estado ===== */
const state={scans:[], form:{operador:"", placas:"", unidad:"Camioneta", factura:""}, lastScanText:null, lastScanAt:0};
const LS_KEY="reporteTarimas_v1";

/* ===== Persistencia ===== */
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderStats(); refreshQR(); }
function loadLS(){ try{const raw=localStorage.getItem(LS_KEY); if(!raw) return; const s=JSON.parse(raw); if(s.scans) state.scans=s.scans; if(s.form) Object.assign(state.form,s.form);}catch{} }

/* ===== UI render ===== */
function renderForm(){ $("#inpOperador").value=state.form.operador; $("#inpPlacas").value=state.form.placas; $("#selUnidad").value=state.form.unidad; $("#inpFactura").value=state.form.factura; }
function renderStats(){ $("#totalCount").textContent=state.scans.length; }
function renderTable(){
  const tbody=$("#tbody"); tbody.innerHTML="";
  state.scans.forEach((s,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td style="word-break:break-word">${s.text}</td><td>${fmt(new Date(s.ts))}</td>
      <td><button class="danger" data-id="${s.id}">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  $$("#tbody .danger").forEach(b=>b.onclick=()=>{ state.scans=state.scans.filter(x=>x.id!==b.dataset.id); saveLS(); renderTable(); });
}

/* ===== QR payload/generación (no mover estructura) ===== */
const getPayload=()=>({
  meta:{v:1, generatedAt:new Date().toISOString()},
  operador:state.form.operador||"", placas:state.form.placas||"", unidad:state.form.unidad||"",
  factura:state.form.factura||"", total:state.scans.length,
  items: state.scans.map(s=>({text:s.text, ts:s.ts}))
});
function drawQR(el,size,text){ el.innerHTML=""; new QRCode(el,{text, width:size, height:size, correctLevel:QRCode.CorrectLevel.M}); }
function refreshQR(){
  const payload=JSON.stringify(getPayload());
  drawQR($("#qrCarga"),140,payload);
  const inner=$("#qrInner"); if(inner){ const size=Math.floor(Math.min(inner.clientWidth, inner.clientHeight)); drawQR(inner,size,payload); }
}

/* ===== Impresión ===== */
function preparePrintView(){
  $("#pOperador").textContent=state.form.operador||"—";
  $("#pPlacas").textContent=state.form.placas||"—";
  $("#pUnidad").textContent=state.form.unidad||"—";
  $("#pFactura").textContent=state.form.factura||"—";
  $("#pFecha").textContent=fmt(new Date());
  $("#pTotal").textContent=state.scans.length;
  $("#pCodigo").textContent=(state.form.operador||"-").slice(0,3).toUpperCase()+"-"+(state.form.placas||"---");
  $("#pFirmaOperador").textContent=(state.form.operador?.trim()?state.form.operador.toUpperCase():"OPERADOR");
  const tb=$("#pTbody"); tb.innerHTML="";
  state.scans.forEach((s,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`; tb.appendChild(tr); });
  refreshQR();
}
const openPrintNow=()=>{ preparePrintView(); requestAnimationFrame(()=>requestAnimationFrame(()=>{ window.focus(); window.print(); })); };
window.addEventListener('beforeprint', preparePrintView);
if(window.matchMedia){ const mq=window.matchMedia('print'); if(mq?.addEventListener){ mq.addEventListener('change',e=>{ if(e.matches) preparePrintView(); }); }}

/* ===== Exportadores ===== */
function makeAOA(){
  const aoa=[
    ["ALDISAN-KSK REPORTE DE EMBARQUE"],
    ["Operador", state.form.operador], ["Placas", state.form.placas],
    ["Tipo de unidad", state.form.unidad], ["Factura/Pedimento", state.form.factura],
    ["Fecha de exportación", fmt(new Date())],
    [], ["#","Contenido QR","Fecha/Hora"]
  ];
  state.scans.forEach((s,i)=>aoa.push([i+1, s.text, fmt(new Date(s.ts))]));
  if(state.scans.length===0) aoa.push(["—","Sin tarimas escaneadas","—"]);
  return aoa;
}
function exportCSV(aoa, name){
  const csv=aoa.map(r=>r.map(v=>{v=(v==null)?"":String(v); v=v.replace(/"/g,'""'); return /[",\n]/.test(v)?`"${v}"`:v;}).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}), url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=name||"reporte_embarque.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function exportXLSX(){
  const aoa=makeAOA();
  try{
    if(typeof XLSX!=="undefined" && XLSX?.utils?.aoa_to_sheet){
      const ws=XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols']=[{wch:5},{wch:80},{wch:20}];
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Embarque");
      XLSX.writeFile(wb,"reporte_embarque.xlsx",{bookType:"xlsx",compression:true});
    }else{ exportCSV(aoa,"reporte_embarque.csv"); }
  }catch(e){ console.error(e); exportCSV(aoa,"reporte_embarque.csv"); }
}

/* ===== Escáner (Html5-Qrcode) con pausa por inactividad ===== */
let html5Scanner=null, lastActivityAt=Date.now(), idleTimer=null;
const IDLE_MS=20000, $overlay=$("#idleOverlay"), $flash=$("#scanFlash"), $camStatus=$("#camStatus");

async function listCameras(){
  try{
    const devices = await Html5Qrcode.getCameras();
    const sel=$("#cameraSelect"); sel.innerHTML="";
    if(!devices?.length){
      $("#scanError").style.display="block";
      $("#scanError").textContent="No se detectaron cámaras. Verifica permisos y que estés en HTTPS.";
      return;
    }
    devices.forEach((d,i)=>{ const opt=document.createElement("option"); opt.value=d.id; opt.textContent=d.label || `Cámara ${i+1}`; sel.appendChild(opt); });
  }catch(e){
    $("#scanError").style.display="block";
    $("#scanError").textContent="No se pudieron listar cámaras. Da permiso de cámara y vuelve a presionar Iniciar.";
  }
}
function startIdleWatch(){ stopIdleWatch(); idleTimer=setInterval(()=>{ if(!html5Scanner) return; if(Date.now()-lastActivityAt>IDLE_MS){ pauseCameraForIdle(); } },1000); }
function stopIdleWatch(){ if(idleTimer){ clearInterval(idleTimer); idleTimer=null; } }

async function startCamera(){
  // requisito: debe ejecutarse en gesto del usuario (click). Ya lo es.
  $("#scanError").style.display="none";
  if(html5Scanner){ try{await html5Scanner.stop();}catch{} html5Scanner=null; }
  const camId = $("#cameraSelect").value || { facingMode:{ exact:"environment" } };
  html5Scanner = new Html5Qrcode("reader",{verbose:false});
  const config = { fps:10, qrbox:{width:260,height:260}, rememberLastUsedCamera:true, aspectRatio:1.333 };

  $camStatus.textContent="Iniciando…";
  try{
    await html5Scanner.start(
      camId,
      config,
      (qrText)=>{
        const now=Date.now();
        if(qrText===state.lastScanText && (now-state.lastScanAt)<1200){ lastActivityAt=now; return; }
        state.lastScanText=qrText; state.lastScanAt=now; lastActivityAt=now;

        // feedback
        $flash.classList.add("show"); setTimeout(()=> $flash.classList.remove("show"),160);
        try{ navigator.vibrate && navigator.vibrate(80); }catch{}

        // guardar sin deduplicar
        state.scans.push({id:uid(), text:qrText, ts:new Date().toISOString()});
        saveLS(); renderTable();
      },
      (err)=>{ /* decode errors se ignoran */ }
    );
    $camStatus.textContent="Activa";
    $("#btnStart").disabled=true; $("#btnStop").disabled=false;
    $overlay.classList.remove("active");
    lastActivityAt=Date.now();
    startIdleWatch();
  }catch(e){
    $("#scanError").style.display="block";
    $("#scanError").textContent="No se pudo iniciar la cámara. Revisa permisos del navegador (HTTPS/permiso de cámara).";
    $camStatus.textContent="Error";
  }
}
async function stopCamera(){
  stopIdleWatch();
  if(html5Scanner){
    try{ await html5Scanner.stop(); }catch{}
    try{ await html5Scanner.clear(); }catch{}
    html5Scanner=null;
  }
  $("#btnStart").disabled=false; $("#btnStop").disabled=true;
  $camStatus.textContent="Detenida";
}
async function pauseCameraForIdle(){
  stopIdleWatch();
  if(html5Scanner){
    try{ await html5Scanner.pause(true); }catch{}
    $overlay.classList.add("active"); $camStatus.textContent="Pausada";
  }
}
async function resumeFromIdle(){
  if(html5Scanner){
    try{ await html5Scanner.resume(); }catch{}
    $overlay.classList.remove("active"); $camStatus.textContent="Activa";
    lastActivityAt=Date.now(); startIdleWatch();
  }else{
    startCamera();
  }
}

/* ===== Eventos UI ===== */
$("#btnStart").onclick = startCamera;     // gesto del usuario
$("#btnStop").onclick  = stopCamera;
$("#btnResume").onclick= resumeFromIdle;
$("#cameraSelect").onchange = startCamera;

$("#btnExportXLSX").onclick = exportXLSX;
$("#btnExportCSV").onclick  = ()=> exportCSV(makeAOA(),"reporte_embarque.csv");
$("#btnPrint").onclick      = ()=> openPrintNow();
$("#btnClear").onclick      = ()=>{
  if(confirm("¿Borrar TODO el reporte (datos + tarimas)?")){
    state.scans=[]; state.form={operador:"",placas:"",unidad:"Camioneta",factura:""};
    saveLS(); renderForm(); renderTable(); refreshQR();
  }
};

// guardado en vivo
$("#inpOperador").oninput=e=>{ state.form.operador=e.target.value; saveLS(); };
$("#inpPlacas").oninput  =e=>{ state.form.placas  =e.target.value; saveLS(); };
$("#selUnidad").onchange =e=>{ state.form.unidad  =e.target.value; saveLS(); };
$("#inpFactura").oninput =e=>{ state.form.factura =e.target.value; saveLS(); };

/* ===== Init ===== */
(async function init(){
  loadLS(); renderForm(); renderStats(); renderTable(); refreshQR();
  await listCameras();
  $("#btnStop").disabled = true;

  // refrescar QR al cambiar campos (por si el usuario no escribe más)
  ["inpOperador","inpPlacas","selUnidad","inpFactura"].forEach(id=>{
    document.getElementById(id).addEventListener("change", refreshQR);
  });

  // mantener vivo el watchdog de inactividad
  ["click","keydown","touchstart"].forEach(ev=>{
    window.addEventListener(ev, ()=>{ lastActivityAt = Date.now(); }, {passive:true});
  });
})();
</script>
</body>
</html>