<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALDISAN - Reporte de Tarimas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* estilos omitidos aquí por brevedad, mantener los tuyos originales sin cambios */
  </style>
</head>
<body>
  <!-- HTML visual igual al que compartiste -->
  <!-- ... -->
  <script>
    let itemCount = 0;
    let totalPieces = 0;
    let cameraStream = null;
    let scanningInterval = null;
    let codigosEscaneados = new Set();
    let registrosExcel = [];

    function procesarCodigoQR(codigo) {
      stopCamera();

      if (codigosEscaneados.has(codigo)) {
        alert("Este código ya fue escaneado.");
        return;
      }
      codigosEscaneados.add(codigo);

      const partes = codigo.trim().split(/\t|\s{2,}/);
      if (partes.length < 9) {
        alert("QR no válido: formato incorrecto");
        return;
      }

      const [operadorQR, folio, codigoId, descripcion, lote, caducidad, pzCaja, cajas, totalPiezasQR] = partes;

      const totalPz = parseInt(pzCaja) * parseInt(cajas);
      totalPieces += totalPz;
      itemCount++;

      const tbody = document.querySelector('#tabla tbody');
      const emptyRow = document.querySelector('.empty-row');
      if (emptyRow) emptyRow.remove();

      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${codigoId}</td>
        <td>${descripcion}</td>
        <td>${lote}</td>
        <td>${pzCaja}</td>
        <td>${cajas}</td>
        <td>${totalPz}</td>
        <td>${caducidad}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-danger btn-small" onclick="removeRow(this, '${codigo}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>`;

      tbody.appendChild(newRow);

      registrosExcel.push({
        operador: operadorQR,
        folio,
        codigo: codigoId,
        descripcion,
        lote,
        caducidad,
        pzCaja: parseInt(pzCaja),
        cajas: parseInt(cajas),
        totalPiezas: totalPz
      });

      updateCounters();
    }

    function removeRow(button, codigo) {
      const row = button.closest('tr');
      const pieces = parseInt(row.cells[5].textContent);
      itemCount--;
      totalPieces -= pieces;
      codigosEscaneados.delete(codigo);

      registrosExcel = registrosExcel.filter(r => r.codigo !== codigo);
      row.remove();

      if (document.querySelectorAll('#tabla tbody tr').length === 0) {
        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = `
          <tr class="empty-row">
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No hay productos escaneados</p>
                <p>Use el botón \"Escanear QR\" para comenzar</p>
              </div>
            </td>
          </tr>`;
      }

      updateCounters();
    }

    function exportarExcel() {
      if (registrosExcel.length === 0) {
        alert("No hay datos para exportar");
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(registrosExcel);
      XLSX.utils.book_append_sheet(wb, ws, "Tarimas");
      XLSX.writeFile(wb, "reporte_tarimas.xlsx");
    }

    function nuevoReporte() {
      if (confirm('¿Está seguro de que desea comenzar un nuevo reporte? Se perderán todos los datos actuales.')) {
        stopCamera();
        resetCameraUI();
        cerrarManual();
        document.getElementById('operador').value = '';
        document.getElementById('placas').value = '';
        document.getElementById('tipoUnidad').value = '';

        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = `
          <tr class="empty-row">
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No hay productos escaneados</p>
                <p>Use el botón \"Escanear QR\" para comenzar</p>
              </div>
            </td>
          </tr>`;

        itemCount = 0;
        totalPieces = 0;
        codigosEscaneados.clear();
        registrosExcel = [];
        updateCounters();
      }
    }

    function updateCounters() {
      document.getElementById('itemCount').textContent = itemCount;
      document.getElementById('totalPieces').textContent = totalPieces;
    }
  </script>
</body>
</html>
