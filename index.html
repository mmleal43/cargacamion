<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ALDISAN-KSK – REPORTE DE EMBARQUE (Tarimas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Librerías -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --c1:#00e5ff; --bg:#0c0f1f; --panel:#151a2b; --muted:#93a4b8;
      --paper-w:21.59cm; --paper-h:27.94cm;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(1000px 600px at 50% -200px,#16304a 10%, var(--bg) 60%, #090c17 100%);
      color:#e6eef7;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header h1{text-align:center;color:var(--c1);font-weight:800;text-shadow:0 0 8px rgba(0,229,255,.35)}
    header p{text-align:center;color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:1.1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;color:#fff}
    #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px solid rgba(255,255,255,.08);overflow:hidden;position:relative}
    .scan-flash{position:absolute;inset:0;background:rgba(0,255,170,.15);box-shadow:inset 0 0 0 2px rgba(0,255,170,.4);opacity:0;transform:scale(1.02);transition:.2s}
    .scan-flash.show{opacity:1;transform:scale(1)}
    .idle-overlay{position:absolute;inset:0;display:none;place-items:center;text-align:center;background:rgba(2,8,23,.85);padding:24px}
    .idle-overlay.active{display:grid}
    .idle-overlay button{margin-top:10px;padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1b2e;color:#fff}
    label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:#e6eef7}
    input:focus,select:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,229,255,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .primary{background:linear-gradient(90deg,#00e5ff,#36d1dc);color:#00131a;font-weight:700}
    .success{background:linear-gradient(90deg,#00d26a,#23e0a5);color:#001a0d;font-weight:700}
    .danger{background:linear-gradient(90deg,#ff7373,#ff4d4d);color:#2a0000;font-weight:700}
    .ghost{background:#0f2438;color:#fff;border:1px solid rgba(255,255,255,.12)}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#0d1526}
    th,td{border:1px solid rgba(255,255,255,.08);padding:8px 10px;text-align:left}
    th{color:#a9c8ff;background:rgba(255,255,255,.04)}
    .qr-block{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #qrCarga{width:140px;height:140px;background:#fff;border-radius:8px;padding:6px}
    footer{margin:18px 0 8px;text-align:center;color:#9fb0c5;font-size:12px}

    /* IMPRESIÓN */
    @media print{
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .wrap{max-width:none;padding:0}
      .grid,header p,.actions,#reader,.card:not(.print-only){display:none!important}
      #printable{display:block!important}
    }
    @page{size:Letter;margin:12mm}
    #printable{display:none;background:#fff;color:#000;width:var(--paper-w);min-height:var(--paper-h);margin:0 auto;padding:1.2cm;font-size:12pt}
    #printable h1{text-align:center;color:#00a8c7}
    #printable .meta{display:grid;grid-template-columns:1.5fr .9fr 3.2cm;gap:.5cm;margin:.4cm 0 .3cm}
    #printable .box{border:1px solid #000;padding:.35cm;border-radius:6px}
    #printable #qrBox{border:1px solid #000;border-radius:6px;padding:.2cm;display:flex;align-items:center;justify-content:center}
    #printable #qrInner{width:3.2cm;height:3.2cm;display:flex;align-items:center;justify-content:center;overflow:hidden}
    #printable #qrInner canvas{max-width:100%;max-height:100%;display:block;margin:auto}
    #printable table{width:100%;border-collapse:collapse;margin-top:.5cm;font-size:11pt}
    #printable th,#printable td{border:1px solid #000;padding:.2cm;text-align:left}
    #printable .firmas{display:grid;grid-template-columns:1fr 1fr;gap:1cm;margin-top:1cm}
    #printable .firma{height:2.5cm;border-top:1px solid #000;text-align:center;padding-top:.2cm}

    /* Fix contraste tabla impresión */
    @media print {
      #printable table{background:#fff!important}
      #printable thead th{background:#f2f2f2!important;color:#000!important;border-color:#000!important}
      #printable tbody td{background:#fff!important;color:#000!important;border-color:#000!important}
      #printable tbody tr{background:#fff!important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <p>Escanea los QR de las tarimas. Guarda, imprime o exporta a Excel.</p>
    </header>

    <div class="grid">
      <!-- Escáner -->
      <section class="card">
        <h2>1) Escáner QR</h2>
        <div id="reader">
          <div class="scan-flash" id="scanFlash"></div>
          <div class="idle-overlay" id="idleOverlay">
            <div><div>Cámara pausada</div><button id="btnResume" class="ghost">Reactivar cámara</button></div>
          </div>
        </div>
        <div class="actions"><button id="btnStart" class="primary">Iniciar cámara</button><button id="btnStop" class="ghost">Detener cámara</button><select id="cameraSelect"></select></div>
        <div>Total escaneos: <b id="totalCount">0</b> · Cámara: <b id="camStatus">Detenida</b></div>
      </section>

      <!-- Datos -->
      <section class="card">
        <h2>2) Datos de embarque</h2>
        <div class="row"><div><label>Operador</label><input id="inpOperador"/></div><div><label>Placas</label><input id="inpPlacas"/></div></div>
        <div class="row" style="margin-top:10px"><div><label>Unidad</label><select id="selUnidad"><option>Camioneta</option><option>Tráiler</option><option>Torton</option><option>Otro</option></select></div><div><label>Factura/Pedimento</label><input id="inpFactura"/></div></div>
        <div style="margin-top:12px" class="qr-block"><div><div style="font-size:12px;color:var(--muted)">QR del embarque</div><div id="qrCarga"></div></div></div>
        <div class="actions"><button id="btnExportXLSX" class="success">Exportar Excel</button><button id="btnExportCSV" class="ghost">Exportar CSV</button><button id="btnPrint" class="primary">Imprimir / PDF</button><button id="btnClear" class="danger">Borrar todo</button></div>
      </section>
    </div>

    <!-- Tarimas -->
    <section class="card" style="margin-top:16px">
      <h2>3) Tarimas escaneadas</h2>
      <table><thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead><tbody id="tbody"></tbody></table>
    </section>

    <!-- Printable -->
    <section id="printable">
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <div class="meta">
        <div class="box"><b>Operador:</b> <span id="pOperador"></span><br><b>Placas:</b> <span id="pPlacas"></span><br><b>Unidad:</b> <span id="pUnidad"></span><br><b>Factura:</b> <span id="pFactura"></span><br><b>Fecha:</b> <span id="pFecha"></span></div>
        <div class="box"><b>Total tarimas:</b> <span id="pTotal"></span><br><b>Código:</b> <span id="pCodigo"></span></div>
        <div id="qrBox"><div id="qrInner"></div></div>
      </div>
      <table><thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead><tbody id="pTbody"></tbody></table>
      <div class="firmas"><div class="firma" id="pFirmaOperador">OPERADOR</div><div class="firma">VÍCTOR GONZÁLES</div></div>
    </section>

    <footer>© ALDISAN-KSK · Herramienta local</footer>
  </div>

<script>
const $=s=>document.querySelector(s);
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const state={scans:[],form:{operador:"",placas:"",unidad:"Camioneta",factura:""}};
function getPayload(){return{meta:{v:1},...state.form,total:state.scans.length,items:state.scans};}
function drawQR(el,size,text){el.innerHTML="";new QRCode(el,{text,width:size,height:size});}
function refreshQR(){const p=JSON.stringify(getPayload());drawQR($("#qrCarga"),140,p);drawQR($("#qrInner"),120,p);}
function renderTable(){const tb=$("#tbody");tb.innerHTML="";state.scans.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`;tb.appendChild(tr);});}
function preparePrint(){ $("#pOperador").textContent=state.form.operador;$("#pPlacas").textContent=state.form.placas;$("#pUnidad").textContent=state.form.unidad;$("#pFactura").textContent=state.form.factura;$("#pFecha").textContent=fmt(new Date());$("#pTotal").textContent=state.scans.length;$("#pCodigo").textContent=(state.form.operador||"-").slice(0,3).toUpperCase()+"-"+(state.form.placas||"---");$("#pFirmaOperador").textContent=(state.form.operador||"OPERADOR").toUpperCase();const pt=$("#pTbody");pt.innerHTML="";state.scans.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`;pt.appendChild(tr);});refreshQR();}
function makeAOA(){const a=[["ALDISAN-KSK REPORTE DE EMBARQUE"],["Operador",state.form.operador],["Placas",state.form.placas],["Unidad",state.form.unidad],["Factura",state.form.factura],["Fecha",fmt(new Date())],[],["#","Contenido QR","Fecha/Hora"]];state.scans.forEach((s,i)=>a.push([i+1,s.text,fmt(new Date(s.ts))]));return a;}
function exportCSV(){const csv=makeAOA().map(r=>r.join(",")).join("\n");const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="reporte.csv";a.click();}
function exportXLSX(){try{const ws=XLSX.utils.aoa_to_sheet(makeAOA());ws['!cols']=[{wch:5},{wch:80},{wch:20}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Embarque");XLSX.writeFile(wb,"reporte.xlsx");}catch(e){exportCSV();}}
$("#btnExportXLSX").onclick=exportXLSX;$("#btnExportCSV").onclick=exportCSV;
$("#btnPrint").onclick=()=>{preparePrint();requestAnimationFrame(()=>window.print());};
$("#btnClear").onclick=()=>{state.scans=[];state.form={operador:"",placas:"",unidad:"Camioneta",factura:""};renderTable();refreshQR();};
$("#inpOperador").oninput=e=>{state.form.operador=e.target.value;refreshQR();};
$("#inpPlacas").oninput=e=>{state.form.placas=e.target.value;refreshQR();};
$("#selUnidad").onchange=e=>{state.form.unidad=e.target.value;refreshQR();};
$("#inpFactura").oninput=e=>{state.form.factura=e.target.value;refreshQR();};
refreshQR();
</script>
</body>
</html>