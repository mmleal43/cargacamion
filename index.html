<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ALDISAN-KSK – REPORTE DE EMBARQUE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Librerías -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{--c1:#00e5ff;--bg:#0c0f1f;--muted:#93a4b8;--paper-w:21.59cm;--paper-h:27.94cm}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#0c0f1f;color:#e6eef7}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header h1{text-align:center;color:var(--c1);font-weight:800}
    header p{text-align:center;color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:1.1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#0d1526}
    th,td{border:1px solid rgba(255,255,255,.1);padding:8px 10px;text-align:left}
    th{background:#162036;color:#a9c8ff}
    #qrCarga{width:140px;height:140px;background:#fff;border-radius:8px;padding:6px}
    footer{margin:18px 0 8px;text-align:center;color:#aab8cc;font-size:12px}
    /* IMPRESIÓN */
    @media print{
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .wrap{max-width:none;padding:0}
      .grid, header p, .actions, #reader, .card:not(.print-only){display:none!important}
      #printable{display:block!important}
    }
    @page{size:Letter;margin:12mm}
    #printable{display:none;background:#fff;color:#000;width:var(--paper-w);min-height:var(--paper-h);margin:0 auto;padding:1.2cm;font-size:12pt}
    #printable h1{text-align:center;color:#00a8c7}
    #printable .meta{display:grid;grid-template-columns:1.5fr .9fr 3.2cm;gap:.5cm;margin:.2cm 0 .4cm}
    #printable .box{border:1px solid #000;padding:.35cm;border-radius:6px}
    #printable #qrBox{border:1px solid #000;padding:.2cm;display:flex;align-items:center;justify-content:center}
    #printable #qrInner{width:3.2cm;height:3.2cm;display:flex;align-items:center;justify-content:center;overflow:hidden}
    #printable #qrInner canvas{max-width:100%;max-height:100%;display:block;margin:auto}
    #printable table{width:100%;border-collapse:collapse;margin-top:.5cm;font-size:11pt}
    #printable th,#printable td{border:1px solid #000;padding:.2cm;text-align:left}
    #printable .firmas{display:grid;grid-template-columns:1fr 1fr;gap:1cm;margin-top:1cm}
    #printable .firma{height:2.5cm;border-top:1px solid #000;text-align:center;padding-top:.2cm}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <p>Escanea los QR de las tarimas. Guarda, imprime o exporta a Excel.</p>
    </header>

    <div class="grid">
      <!-- Escáner -->
      <section class="card">
        <h2>1) Escáner QR</h2>
        <div id="reader"></div>
        <div class="actions">
          <button id="btnStart">Iniciar cámara</button>
          <button id="btnStop">Detener cámara</button>
          <select id="cameraSelect"></select>
        </div>
        <div>Total escaneos: <b id="totalCount">0</b> · Cámara: <b id="camStatus">Detenida</b></div>
      </section>

      <!-- Datos -->
      <section class="card">
        <h2>2) Datos de embarque</h2>
        <div><label>Operador</label><input id="inpOperador"></div>
        <div><label>Placas</label><input id="inpPlacas"></div>
        <div><label>Unidad</label><select id="selUnidad"><option>Camioneta</option><option>Tráiler</option><option>Torton</option><option>Otro</option></select></div>
        <div><label>Factura/Pedimento</label><input id="inpFactura"></div>
        <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
          <div id="qrCarga"></div>
          <div style="color:#aaa">El QR se añade a la impresión automáticamente</div>
        </div>
        <div class="actions">
          <button id="btnExportXLSX">Exportar Excel</button>
          <button id="btnExportCSV">Exportar CSV</button>
          <button id="btnPrint">Imprimir / Guardar PDF</button>
          <button id="btnClear">Borrar todo</button>
        </div>
      </section>
    </div>

    <!-- Tabla -->
    <section class="card" style="margin-top:16px">
      <h2>3) Tarimas escaneadas</h2>
      <table>
        <thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Printable -->
    <section id="printable">
      <h1>ALDISAN-KSK · REPORTE DE EMBARQUE</h1>
      <div class="meta">
        <div class="box">
          <b>Operador:</b> <span id="pOperador"></span><br>
          <b>Placas:</b> <span id="pPlacas"></span><br>
          <b>Unidad:</b> <span id="pUnidad"></span><br>
          <b>Factura:</b> <span id="pFactura"></span><br>
          <b>Fecha reporte:</b> <span id="pFecha"></span>
        </div>
        <div class="box">
          <b>Total tarimas:</b> <span id="pTotal"></span><br>
          <b>Código embarque:</b> <span id="pCodigo"></span>
        </div>
        <div id="qrBox"><div id="qrInner"></div></div>
      </div>
      <table><thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead><tbody id="pTbody"></tbody></table>
      <div class="firmas"><div class="firma" id="pFirmaOperador">OPERADOR</div><div class="firma">VÍCTOR GONZÁLES</div></div>
    </section>

    <footer>© ALDISAN-KSK · Herramienta local de reporte de tarimas</footer>
  </div>

  <script>
  const $=s=>document.querySelector(s);
  const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  const state={scans:[],form:{operador:"",placas:"",unidad:"Camioneta",factura:""}};
  function refreshQR(){const payload=JSON.stringify({meta:{v:1},...state.form,total:state.scans.length,items:state.scans});$("#qrCarga").innerHTML="";new QRCode($("#qrCarga"),{text:payload,width:140,height:140});$("#qrInner").innerHTML="";new QRCode($("#qrInner"),{text:payload,width:120,height:120});}
  function preparePrint(){ $("#pOperador").textContent=state.form.operador; $("#pPlacas").textContent=state.form.placas; $("#pUnidad").textContent=state.form.unidad; $("#pFactura").textContent=state.form.factura; $("#pFecha").textContent=fmt(new Date()); $("#pTotal").textContent=state.scans.length; $("#pCodigo").textContent=(state.form.operador||"-").slice(0,3).toUpperCase()+"-"+(state.form.placas||"---"); $("#pFirmaOperador").textContent=(state.form.operador||"OPERADOR").toUpperCase(); const tb=$("#pTbody");tb.innerHTML="";state.scans.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.text}</td><td>${fmt(new Date(s.ts))}</td>`;tb.appendChild(tr);}); refreshQR(); }
  function makeAOA(){const aoa=[["ALDISAN-KSK REPORTE DE EMBARQUE"],["Operador",state.form.operador],["Placas",state.form.placas],["Unidad",state.form.unidad],["Factura",state.form.factura],["Fecha exportación",fmt(new Date())],[],["#","Contenido QR","Fecha/Hora"]]; state.scans.forEach((s,i)=>aoa.push([i+1,s.text,fmt(new Date(s.ts))])); return aoa;}
  function exportCSV(){const aoa=makeAOA(); const csv=aoa.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="reporte_embarque.csv";a.click();}
  function exportXLSX(){const aoa=makeAOA(); try{const ws=XLSX.utils.aoa_to_sheet(aoa);ws['!cols']=[{wch:5},{wch:80},{wch:20}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Embarque");XLSX.writeFile(wb,"reporte_embarque.xlsx",{bookType:"xlsx",compression:true});}catch(e){exportCSV();}}
  $("#btnExportXLSX").onclick=exportXLSX; $("#btnExportCSV").onclick=exportCSV;
  $("#btnPrint").onclick=()=>{preparePrint(); requestAnimationFrame(()=>requestAnimationFrame(()=>window.print()));};
  $("#btnClear").onclick=()=>{state.scans=[];state.form={operador:"",placas:"",unidad:"Camioneta",factura:""};refreshQR();};
  ["inpOperador","inpPlacas","selUnidad","inpFactura"].forEach(id=>document.getElementById(id).oninput=e=>{state.form[id.replace("inp","").toLowerCase()]=e.target.value;refreshQR();});
  refreshQR();
  </script>
</body>
</html>